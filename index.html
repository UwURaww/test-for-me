import React, { useEffect, useMemo, useRef, useState } from "react"; import { motion, AnimatePresence } from "framer-motion"; import { Button } from "@/components/ui/button"; import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"; import { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog"; import { Input } from "@/components/ui/input"; import { Label } from "@/components/ui/label"; import { ScrollArea } from "@/components/ui/scroll-area"; import { Separator } from "@/components/ui/separator"; import { Badge } from "@/components/ui/badge"; import { toast } from "sonner"; import { Plus, Loader2, Lock, ShieldCheck, ExternalLink, Copy, Trash2, RefreshCw, Search } from "lucide-react";

/**

GitHub Raw Viewer â€” single-file React app

Stores scripts locally (this device only) in localStorage


"Owner Mode" gate so only your device can add/edit/delete


Add Script modal with Name + Raw GitHub URL


Fetches and displays file contents in beautiful code cards


Per-card: Copy, Open Raw, Refresh, (Delete in Owner Mode)


Search by title */



const STORAGE_KEYS = { scripts: "gh_raw_viewer:scripts", ownerPassSet: "gh_raw_viewer:ownerPassSet", ownerPass: "gh_raw_viewer:ownerPass", // stored locally on this device only ownerMode: "gh_raw_viewer:ownerMode", };

function loadLocal(key, fallback) { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; } } function saveLocal(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

function isLikelyRawUrl(url) { try { const u = new URL(url); return ( u.hostname === "raw.githubusercontent.com" || u.hostname === "gist.githubusercontent.com" || /github.com/.+/raw/.test(u.href) ); } catch { return false; } }

export default function App() { const [ownerMode, setOwnerMode] = useState(() => !!loadLocal(STORAGE_KEYS.ownerMode, false)); const [ownerPassSet, setOwnerPassSet] = useState(() => !!loadLocal(STORAGE_KEYS.ownerPassSet, false)); const [showOwnerDialog, setShowOwnerDialog] = useState(false); const [passInput, setPassInput] = useState("");

const [scripts, setScripts] = useState(() => loadLocal(STORAGE_KEYS.scripts, [])); const [isAddOpen, setIsAddOpen] = useState(false); const [newName, setNewName] = useState(""); const [newUrl, setNewUrl] = useState(""); const [loadingId, setLoadingId] = useState(null); const [query, setQuery] = useState("");

useEffect(() => { saveLocal(STORAGE_KEYS.scripts, scripts); }, [scripts]);

useEffect(() => { saveLocal(STORAGE_KEYS.ownerMode, ownerMode); }, [ownerMode]);

const filtered = useMemo(() => { if (!query.trim()) return scripts; return scripts.filter((s) => s.name.toLowerCase().includes(query.toLowerCase())); }, [scripts, query]);

const enableOwnerMode = () => setShowOwnerDialog(true);

const handleOwnerConfirm = () => { const existing = loadLocal(STORAGE_KEYS.ownerPass, ""); if (!ownerPassSet) { if (passInput.trim().length < 4) { toast.error("Passcode must be at least 4 characters."); return; } saveLocal(STORAGE_KEYS.ownerPass, passInput); saveLocal(STORAGE_KEYS.ownerPassSet, true); setOwnerPassSet(true); setOwnerMode(true); toast.success("Owner Mode enabled on this device."); setShowOwnerDialog(false); setPassInput(""); return; } if (existing && passInput === existing) { setOwnerMode(true); toast.success("Owner Mode enabled."); setShowOwnerDialog(false); setPassInput(""); } else { toast.error("Wrong passcode for this device."); } };

const disableOwnerMode = () => { setOwnerMode(false); toast("Owner Mode disabled."); };

async function fetchContent(url) { const res = await fetch(url, { cache: "no-store" }); if (!res.ok) throw new Error(HTTP ${res.status}); return await res.text(); }

async function addScript() { if (!newName.trim() || !newUrl.trim()) { toast.error("Please enter a name and a raw GitHub link."); return; } if (!isLikelyRawUrl(newUrl)) { toast("Tip: use a direct RAW link from GitHub for best results."); } const id = crypto.randomUUID(); setLoadingId(id); try { const content = await fetchContent(newUrl); const item = { id, name: newName.trim(), url: newUrl.trim(), content, lastFetched: Date.now(), }; setScripts((prev) => [item, ...prev]); setIsAddOpen(false); setNewName(""); setNewUrl(""); toast.success("Script added."); } catch (e) { toast.error(Failed to fetch: ${e.message}); } finally { setLoadingId(null); } }

async function refreshScript(id) { const idx = scripts.findIndex((s) => s.id === id); if (idx === -1) return; setLoadingId(id); try { const content = await fetchContent(scripts[idx].url); const updated = { ...scripts[idx], content, lastFetched: Date.now() }; const next = [...scripts]; next[idx] = updated; setScripts(next); toast.success("Refreshed."); } catch (e) { toast.error(Refresh failed: ${e.message}); } finally { setLoadingId(null); } }

function deleteScript(id) { setScripts((prev) => prev.filter((s) => s.id !== id)); toast("Deleted."); }

function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => toast.success("Copied to clipboard.")); }

return ( <div className="min-h-screen bg-gradient-to-b from-slate-50 to-white text-slate-900"> {/* Top bar /} <header className="sticky top-0 z-50 backdrop-blur supports-[backdrop-filter]:bg-white/60 bg-white/70 border-b"> <div className="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3"> {/ Top-left Add button (only visible in Owner Mode) */} {ownerMode ? ( <Button onClick={() => setIsAddOpen(true)} className="rounded-2xl shadow" size="sm"> <Plus className="mr-2 h-4 w-4" /> Add Script </Button> ) : ( <div className="w-[112px]" /> )}

<Separator orientation="vertical" className="mx-1 h-6" />

      <h1 className="font-semibold text-lg sm:text-xl tracking-tight">GitHub Raw Viewer</h1>
      <Badge variant="secondary" className="ml-2 hidden sm:inline-flex">Professional</Badge>

      <div className="ml-auto flex items-center gap-2">
        <div className="relative">
          <Search className="absolute left-2 top-2.5 h-4 w-4 opacity-60" />
          <Input
            value={query}
            onChange={(e) => setQuery(e.target.value)}
            placeholder="Search by title..."
            className="pl-8 w-48 md:w-64 rounded-2xl"
          />
        </div>

        {/* Owner Mode controls */}
        {ownerMode ? (
          <Button variant="outline" size="sm" className="rounded-2xl" onClick={disableOwnerMode}>
            <ShieldCheck className="mr-2 h-4 w-4" /> Owner Mode
          </Button>
        ) : (
          <Button variant="outline" size="sm" className="rounded-2xl" onClick={enableOwnerMode}>
            <Lock className="mr-2 h-4 w-4" /> Enable Owner Mode
          </Button>
        )}
      </div>
    </div>
  </header>

  {/* Content grid */}
  <main className="max-w-6xl mx-auto px-4 py-6">
    {filtered.length === 0 ? (
      <EmptyState ownerMode={ownerMode} onAdd={() => setIsAddOpen(true)} />
    ) : (
      <div className="grid gap-4 sm:gap-6 grid-cols-1 md:grid-cols-2">
        <AnimatePresence>
          {filtered.map((s) => (
            <motion.div
              key={s.id}
              layout
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.98 }}
              transition={{ duration: 0.2 }}
            >
              <Card className="rounded-2xl shadow-sm border-slate-200">
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-base font-semibold truncate max-w-[60%]" title={s.name}>
                    {s.name}
                  </CardTitle>
                  <div className="flex items-center gap-2">
                    <Button
                      variant="ghost"
                      size="icon"
                      className="h-8 w-8"
                      onClick={() => window.open(s.url, "_blank")}
                      title="Open raw link"
                    >
                      <ExternalLink className="h-4 w-4" />
                    </Button>
                    <Button
                      variant="ghost"
                      size="icon"
                      className="h-8 w-8"
                      onClick={() => copyToClipboard(s.content)}
                      title="Copy content"
                    >
                      <Copy className="h-4 w-4" />
                    </Button>
                    <Button
                      variant="ghost"
                      size="icon"
                      className="h-8 w-8"
                      onClick={() => refreshScript(s.id)}
                      title="Refresh content"
                      disabled={loadingId === s.id}
                    >
                      {loadingId === s.id ? <Loader2 className="h-4 w-4 animate-spin" /> : <RefreshCw className="h-4 w-4" />}
                    </Button>
                    {ownerMode && (
                      <Button
                        variant="ghost"
                        size="icon"
                        className="h-8 w-8 text-red-600"
                        onClick={() => deleteScript(s.id)}
                        title="Delete (this device only)"
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    )}
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="text-xs text-slate-500 mb-2">
                    <span className="font-medium">Last fetched:</span>{" "}
                    {new Date(s.lastFetched).toLocaleString()} 
                  </div>
                  <div className="border rounded-xl overflow-hidden">
                    <ScrollArea className="h-64">
                      <pre className="p-4 text-sm leading-relaxed whitespace-pre-wrap font-mono">
                        {s.content}
                      </pre>
                    </ScrollArea>
                  </div>
                </CardContent>
              </Card>
            </motion.div>
          ))}
        </AnimatePresence>
      </div>
    )}
  </main>

  {/* Add Script Modal */}
  <Dialog open={isAddOpen} onOpenChange={setIsAddOpen}>
    <DialogContent className="rounded-2xl sm:max-w-lg">
      <DialogHeader>
        <DialogTitle>Add a new script</DialogTitle>
      </DialogHeader>
      <div className="space-y-4">
        <div className="space-y-2">
          <Label htmlFor="name">Script name (title)</Label>
          <Input
            id="name"
            placeholder="e.g. Teleport Tool"
            value={newName}
            onChange={(e) => setNewName(e.target.value)}
            className="rounded-2xl"
          />
        </div>
        <div className="space-y-2">
          <Label htmlFor="url">Raw GitHub link</Label>
          <Input
            id="url"
            placeholder="https://raw.githubusercontent.com/user/repo/branch/path/file.lua"
            value={newUrl}
            onChange={(e) => setNewUrl(e.target.value)}
            className="rounded-2xl"
          />
          <p className="text-xs text-slate-500">
            Tip: open your file on GitHub and click <span className="font-medium">Raw</span>, then copy the URL.
          </p>
        </div>
      </div>
      <DialogFooter>
        <Button variant="outline" className="rounded-2xl" onClick={() => setIsAddOpen(false)}>
          Cancel
        </Button>
        <Button className="rounded-2xl" onClick={addScript} disabled={!!loadingId}>
          {loadingId ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : null}
          Confirm
        </Button>
      </DialogFooter>
    </DialogContent>
  </Dialog>

  {/* Owner Mode Dialog */}
  <Dialog open={showOwnerDialog} onOpenChange={setShowOwnerDialog}>
    <DialogContent className="rounded-2xl sm:max-w-md">
      <DialogHeader>
        <DialogTitle>{ownerPassSet ? "Enter owner passcode" : "Set an owner passcode"}</DialogTitle>
      </DialogHeader>
      <div className="space-y-2">
        <Label htmlFor="pass">Passcode (this device only)</Label>
        <Input
          id="pass"
          type="password"
          placeholder={ownerPassSet ? "Enter your passcode" : "Create a passcode (min 4 chars)"}
          value={passInput}
          onChange={(e) => setPassInput(e.target.value)}
          className="rounded-2xl"
        />
        <p className="text-xs text-slate-500">
          The passcode is saved locally on <span className="font-medium">this device only</span> and never uploaded.
        </p>
      </div>
      <DialogFooter>
        <Button variant="outline" className="rounded-2xl" onClick={() => setShowOwnerDialog(false)}>
          Cancel
        </Button>
        <Button className="rounded-2xl" onClick={handleOwnerConfirm}>
          {ownerPassSet ? "Unlock" : "Save & Enable"}
        </Button>
      </DialogFooter>
    </DialogContent>
  </Dialog>

  <footer className="max-w-6xl mx-auto px-4 py-8 text-xs text-slate-500">
    <Separator className="mb-4" />
    <p>
      <span className="font-medium">Note:</span> Scripts and passcode are stored in your browser's localStorage. To restrict adding scripts to your
      device, keep Owner Mode locked on other devices.
    </p>
  </footer>
</div>

); }

function EmptyState({ ownerMode, onAdd }) { return ( <div className="flex flex-col items-center justify-center py-24 text-center"> <div className="mb-6"> <motion.div initial={{ scale: 0.9, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} transition={{ duration: 0.3 }} className="h-16 w-16 rounded-2xl grid place-items-center shadow bg-white border" > <Lock className="h-8 w-8" /> </motion.div> </div> <h2 className="text-xl font-semibold mb-2">No scripts yet</h2> <p className="text-sm text-slate-600 max-w-md"> Add GitHub <span className="font-medium">RAW</span> links and read them here with clean formatting. Everything stays on this device. </p> <div className="mt-6"> {ownerMode ? ( <Button onClick={onAdd} className="rounded-2xl"> <Plus className="mr-2 h-4 w-4" /> Add your first script </Button> ) : ( <div className="text-sm text-slate-500"> Enable <span className="font-medium">Owner Mode</span> to add scripts. </div> )} </div> </div> ); }

